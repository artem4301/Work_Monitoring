# Система периодической верификации

## Описание

Система автоматически требует прохождения фотоконтроля каждые 4 часа во время активной смены. При наступлении времени верификации:

1. **Смена автоматически приостанавливается**
2. **Время работы перестает засчитываться**
3. **Пользователь получает уведомление**
4. **Работа возобновляется только после успешной верификации**

## Компоненты системы

### 1. PeriodicVerificationService
- **Файл**: `app/src/main/java/com/example/workmonitoring/service/PeriodicVerificationService.kt`
- **Функции**:
  - Проверяет каждые 5 минут необходимость верификации
  - Требует верификацию каждые 4 часа
  - Автоматически приостанавливает смену
  - Отправляет уведомления

### 2. Обновленные активности

#### HomeActivity
- Запускает сервис периодической верификации при активной смене
- Проверяет статус верификации при загрузке
- Показывает диалог если требуется верификация

#### WorkTimeActivity  
- Отображает статус "Требуется верификация"
- Показывает диалог с требованием пройти фотоконтроль
- Приостанавливает отсчет времени
- Обновляет статус в реальном времени

#### FaceControlActivity
- Поддерживает режим периодической верификации
- Автоматически возобновляет смену после успешной верификации
- Блокирует выход без прохождения верификации

### 3. Расширенная модель данных

#### User (модель пользователя)
Новые поля:
- `lastVerificationTime` - время последней верификации
- `verificationRequired` - флаг необходимости верификации  
- `shiftPaused` - флаг приостановки смены
- `pauseReason` - причина приостановки
- `totalVerifications` - общее количество верификаций
- `failedVerifications` - количество неудачных верификаций

#### FirebaseRepository
Новые методы:
- `setVerificationRequired()` - установка флага верификации
- `pauseShift()` - приостановка смены
- `resumeShift()` - возобновление смены  
- `saveVerificationResult()` - сохранение результата
- `getVerificationHistory()` - история верификаций

## Логика работы

### Временные интервалы
- **Интервал верификации**: 4 часа (14,400,000 мс)
- **Частота проверки**: каждые 5 минут
- **Отсчет времени**: от последней верификации или начала смены

### Алгоритм проверки
```kotlin
val currentTime = System.currentTimeMillis()
val lastVerification = user.lastVerificationTime ?: user.shiftStartTime ?: 0L
val timeSinceLastVerification = currentTime - lastVerification

if (timeSinceLastVerification >= 4 * 60 * 60 * 1000L && !user.verificationRequired) {
    // Требуется верификация
    setVerificationRequired(userId, true)
    pauseShift(userId, "Требуется периодическая верификация")
    showNotification()
}
```

### Состояния смены
1. **Активная** - нормальная работа, время засчитывается
2. **Приостановлена (верификация)** - ожидание фотоконтроля
3. **Приостановлена (вне зоны)** - пользователь вне рабочей зоны
4. **Завершена** - смена окончена

## Тестирование системы

### TestPeriodicVerificationActivity
Специальная активность для тестирования системы:

**Доступ**: Долгое нажатие на имя пользователя в HomeActivity

**Функции**:
- Запуск/остановка сервиса верификации
- Симуляция требования верификации
- Установка времени верификации на 4+ часов назад
- Сброс времени верификации
- Просмотр детального статуса

### Сценарии тестирования

#### 1. Тест автоматической верификации
1. Запустить смену
2. Установить время верификации на 4+ часов назад
3. Дождаться срабатывания (до 5 минут)
4. Проверить приостановку смены и уведомление

#### 2. Тест успешной верификации
1. Симулировать требование верификации
2. Пройти фотоконтроль успешно
3. Проверить возобновление смены

#### 3. Тест неудачной верификации
1. Симулировать требование верификации  
2. Попытаться пройти фотоконтроль с чужим лицом
3. Проверить, что смена остается приостановленной

## Уведомления

### Канал уведомлений
- **ID**: `periodic_verification_channel`
- **Название**: "Периодическая верификация"
- **Важность**: HIGH

### Содержание уведомления
- **Заголовок**: "Требуется верификация"
- **Текст**: "Пройдите фотоконтроль для продолжения смены"
- **Действие**: Переход к FaceControlActivity
- **Иконка**: `ic_face_verification`

## Интеграция с существующими системами

### Совместимость с отслеживанием зоны
- Система работает независимо от LocationTrackingService
- Приостановка по верификации имеет приоритет над приостановкой по зоне
- При возобновлении учитываются обе причины приостановки

### Совместимость с отчетами
- Все верификации сохраняются в историю
- Статистика включается в отчеты менеджера
- Время пауз корректно учитывается в рабочем времени

## Настройки и конфигурация

### Изменение интервала верификации
В `PeriodicVerificationService.kt`:
```kotlin
companion object {
    private const val VERIFICATION_INTERVAL = 4 * 60 * 60 * 1000L // 4 часа
}
```

### Изменение частоты проверки
В методе `startPeriodicVerification()`:
```kotlin
handler.postDelayed(this, 5 * 60 * 1000L) // 5 минут
```

## Безопасность

### Защита от обхода
- Нельзя выйти из FaceControlActivity без верификации
- Сервис автоматически перезапускается при перезагрузке приложения
- Время смены не засчитывается до прохождения верификации
- Все попытки верификации логируются

### Обработка ошибок
- Сетевые ошибки не блокируют верификацию навсегда
- При критических ошибках пользователь может обратиться к администратору
- Логирование всех операций для отладки

## Производительность

### Оптимизации
- Проверка каждые 5 минут вместо постоянного мониторинга
- Кэширование данных пользователя
- Минимальное использование батареи
- Эффективные Firebase запросы

### Мониторинг
- Подробное логирование в Android Log
- Отслеживание времени выполнения операций
- Статистика успешности верификаций 